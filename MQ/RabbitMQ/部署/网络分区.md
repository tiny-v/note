## 网络分区(脑裂)

### 一、啥是网络分区
当一个集群发生网络分区时，集群会分为两个部分或者更多，它们各自为政，互相都认为对方分区内的节点已经挂了。
包括队列、交换器及绑定等元数据的创建和销毁都处于自身分区内，与其他分区无关。分区的引入是为了配合RabbitMQ的数据一致性复制原理。
一般情况下，网络分区都是由于单个节点的故障引起的，且通常会形成一个大分区和一个单节点分区，如果配置了镜像，那么可以在不影响服务可用性的情况下从网络分区的情形下得以恢复。


### 二、实记一次解决网络分区问题

> 早上，因为断电的原因。 RabbitMQ集群所在的三个物理节点都跪了。。 等恢复供电后打开RabbitMQ管理界面，就出现了下面的模样。

![img.png](../img/net_partition.png)

### 恢复步骤：

1. 先到三个节点上，各看看当前节点情况。 (使用命令:rabbitmq-diagnostics cluster_status)

> node1 当前状态：
>
> ![img.png](../img/node1_status.png)

> node2 当前状态：
> 
> ![img.png](../img/node2_status.png) 


> node3 当前状态
> 
> ![img.png](../img/node3_status.png)

状态统计：

| node1 | node2  | node3 |
|-------|--------|-------|
| 显示和node3产生网络分区 |  docker服务未启动 | 显示和node1产生网络分区 |


2. 先启动node2节点的docker服务

启动后 ，管理界面显示如下
![img.png](../img/net_partition2.png)

> node1 当前状态
> 
> ![img.png](../img/node1_status2.png)


> node2 当前状态
> 
> ![img.png](../img/node2_status2.png)

> node3 当前状态
> 
> ![img.png](../img/node3_status2.png)

状态统计：

| node1 | node2  | node3 |
|-------|--------|-------|
| 显示和node3产生网络分区 |  正常 | 显示和node1产生网络分区 |

3. 有两种方式处理网络分区

3.1  先选择一个信任的分区(发生在其他分区的改变将不被记录到Mnesia中而直接丢弃)。 然后重启其它分区里的节点。 其它节点重启完后，之后重新将这些节点加入到当前信任的分区之中。
然后再重启这个受信任分区里的节点， 来去除告警。

3.2 先关闭所有的节点，选择一个信任的分区，然后再优先启动这个受信任分区里的节点， 之后再启动其它节点。

