# RabbitMQ 部署模式

## 节点

### 节点类型

#### 1. 磁盘节点
> 磁盘节点将集群的运行时状态会同时存储在内存和磁盘上，(注：运行时状态包括集群、队列、绑定、虚拟主机、用户和策略等信息的定义）
> 
> 因此，如果集群拥有大量的运行时状态时，相比内存节点，磁盘节点更容易受到磁盘I/0问题的困扰。

#### 2.内存节点:
> 内存节点仅将运行时状态信息存储在内存数据库中。

#### 3.状态节点:
> 如果使用 rabbitmq 管理插件的话，那么可以使用另一种节点类型， 即统计节点 Stats node。 
> 
> 它只能和磁盘节点搭配使用。统计节点负责收集集群中每个节点的全部统计数据和状态数据。
> 
> 在任何时刻，集群只能有一个统计节点。
> 
>对于大型集群设置来说，最佳策略是配置专门的管理节点，主磁盘节点和统计节点，并再至少配置一个磁盘节点以提供故转移的能力

![img.png](../img/cluster_node.png)

```
Tips: 在拥有两个磁盘节点的集群拓扑设置中， 如果主节点发生故障的话，统计节点将会被
指派给磁盘节点。当主磁盘节点恢复并重新加入集群后，它并不会重新获得统计节点，
除非被指派为统计节点的备用节点停止运行或者离开集群。
```

### 节点类型和消息持久化
> 不论是哪种节点类型都不会影响消息持久化的行为。当通过消息属性 delivery
mode 一条消息标记为持久化时，这条消息会被写入磁盘，而无关乎节点类型。因此，考虑
磁盘 1/0 RabbitMQ 集群节点的影响就显得很尤为重要

### 节点类型与崩溃行为

> 当节点或者集群崩溃时，在磁盘节点启动并重新加入集群时，会被用来重建集群的运
行时状态。而对于内存节点来说，当加入集群时则不会包含任何运行时状态数据。在重新加
入集群时，集群中的其他节点会将诸如队列定义等信息发送给它。

```
Tips:

当创建集群时，确保至少存在一个磁盘型节点。当集群中拥有多个磁盘节点时，就能在发生硬件故障时更加游刃有余.
 
但多个磁盘节点在某些故障场景下是一把双刃剑。当集群中有多个节点故障时，如果其中两个磁盘节点对集群的共享状态不一致，那么你在尝试将集群恢复至先前状态时就会遇到困难。

假设这事儿真的发生了，那么建议将整个集群关闭并按顺序重启节点。启动那个持有最多正确状态数据的磁盘节点，然后再添加其他节点。
```